###############################################################################
#                                                                             #
# makefile.def                                                                #
#                                                                             #
# EPFL-STI-IEL-ESL                                                            #
# BÃ¢timent ELG, ELG 130                                                       #
# Station 11                                                                  #
# 1015 Lausanne, Switzerland                    alessandro.vincenzi@epfl.ch   #
###############################################################################

#
# Thermal Library variables
###############################################################################

TL_LIB     = $(TL_MAIN)/lib
TL_INCLUDE = $(TL_MAIN)/include
TL_SOURCES = $(TL_MAIN)/sources
TL_BISON   = $(TL_MAIN)/bison
TL_FLEX    = $(TL_MAIN)/flex

TL_FLEX_OBJECTS   = $(TL_FLEX)/floorplan_scanner.o            \
                    $(TL_FLEX)/stack_description_scanner.o

TL_BISON_OBJECTS  = $(TL_BISON)/floorplan_parser.o            \
                    $(TL_BISON)/stack_description_parser.o

TL_SOURCE_OBJECTS = $(TL_SOURCES)/channel.o                   \
                    $(TL_SOURCES)/conductances.o              \
                    $(TL_SOURCES)/die.o                       \
                    $(TL_SOURCES)/dimensions.o                \
                    $(TL_SOURCES)/environment_heat_sink.o     \
                    $(TL_SOURCES)/floorplan.o                 \
                    $(TL_SOURCES)/floorplan_element.o         \
                    $(TL_SOURCES)/layer.o                     \
                    $(TL_SOURCES)/material.o                  \
                    $(TL_SOURCES)/stack_description.o         \
                    $(TL_SOURCES)/stack_element.o             \
                    $(TL_SOURCES)/system_matrix.o             \
                    $(TL_SOURCES)/system_vector.o             \
                    $(TL_SOURCES)/thermal_data.o

TL_LIB_OBJECTS    = $(TL_FLEX_OBJECTS) $(TL_BISON_OBJECTS) $(TL_SOURCE_OBJECTS)

TL_ARCHIVE        = $(TL_LIB)/libThermalLibrary.a

#
# SuperLU variables
###############################################################################

SLU_MAIN    = $(TL_MAIN)/../EPFL/SuperLU_4.0
SLU_INCLUDE = $(SLU_MAIN)/SRC

#
# Commands and flags
###############################################################################

AR        = ar
ARFLAGS   = rsv

CC        = gcc
CFLAGS    = -MD 
CINCLUDES = -I $(TL_INCLUDE)

YACC      = bison
YFLAGS    = -d

LEX       = flex
LFLAGS    =

RM        = rm
RMFLAGS   = -vf

#
# Pattern rules
###############################################################################

%.c: %.y
	$(YACC) $(YFLAGS) $(notdir $<)

%.c: %.l
	$(LEX) $(LFLAGS) $(notdir $<)

%.o : %.c
	$(CC) $(CFLAGS) $(CINCLUDES) -c $< -o $@
	@cp $*.d $*.dd
	@sed -e 's/#.*//'       \
             -e 's/^[^:]*: *//' \
             -e 's/ *\\$$//'    \
	     -e '/^$$/ d'       \
             -e 's/$$/ :/' < $*.dd >> $*.d
	@rm -f $*.dd

