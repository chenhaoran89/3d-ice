###############################################################################
# Makefile "3D-ICe/makefile.def"                                              #
#                                                                             #
# This file is part of 3D-ICe (http://esl.epfl.ch/3D-ICe), revision 0.1       #
#                                                                             #
# 3D-ICe is free software: you can redistribute it and/or modify it under     #
# the terms of the GNU General Public License as published by the Free        #
# Software Foundation, either version 3 of the License, or any later          #
# version.                                                                    #
#                                                                             #
# 3D-ICe is distributed in the hope that it will be useful, but WITHOUT       #
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or       #
# FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for    #
# more details.                                                               #
#                                                                             #
# You should have received a copy of the GNU General Public License along     #
# with 3D-ICe.  If not, see <http://www.gnu.org/licenses/>.                   #
#                                                                             #
# Copyright (C) 2010,                                                         #
# Embedded Systems Laboratory - Ecole Polytechnique Federale de Lausanne.     #
# All Rights Reserved.                                                        #
#                                                                             #
# Authors: Alessandro Vincenzi, Arvind Sridhar.                               #
#                                                                             #
# EPFL-STI-IEL-ESL                                                            #
# BÃ¢timent ELG, ELG 130                                                       #
# Station 11                                                                  #
# 1015 Lausanne, Switzerland                          threed-ice@esl.epfl.ch  #
###############################################################################

#
# Thermal Library variables
###############################################################################

LIB_NAME      = threedice

TDICE_INCLUDE = $(TDICE_MAIN)/include
TDICE_FLEX    = $(TDICE_MAIN)/flex
TDICE_BISON   = $(TDICE_MAIN)/bison
TDICE_SOURCES = $(TDICE_MAIN)/sources
TDICE_LIB     = $(TDICE_MAIN)/lib
TDICE_TEST    = $(TDICE_MAIN)/test

TDICE_FLEX_OBJECTS   = $(TDICE_FLEX)/floorplan_scanner.o            \
                       $(TDICE_FLEX)/stack_description_scanner.o

TDICE_BISON_OBJECTS  = $(TDICE_BISON)/floorplan_parser.o            \
                       $(TDICE_BISON)/stack_description_parser.o

TDICE_SOURCE_OBJECTS = $(TDICE_SOURCES)/channel.o                   \
                       $(TDICE_SOURCES)/conductances.o              \
                       $(TDICE_SOURCES)/die.o                       \
                       $(TDICE_SOURCES)/dimensions.o                \
                       $(TDICE_SOURCES)/environment_heat_sink.o     \
                       $(TDICE_SOURCES)/floorplan.o                 \
                       $(TDICE_SOURCES)/floorplan_element.o         \
                       $(TDICE_SOURCES)/layer.o                     \
                       $(TDICE_SOURCES)/material.o                  \
                       $(TDICE_SOURCES)/powers_queue.o              \
                       $(TDICE_SOURCES)/stack_description.o         \
                       $(TDICE_SOURCES)/stack_element.o             \
                       $(TDICE_SOURCES)/system_matrix.o             \
                       $(TDICE_SOURCES)/system_vector.o             \
                       $(TDICE_SOURCES)/thermal_data.o

TDICE_LIB_OBJECTS    = $(TDICE_FLEX_OBJECTS)                        \
                       $(TDICE_BISON_OBJECTS)                       \
                       $(TDICE_SOURCE_OBJECTS)

TDICE_ARCHIVE        = $(TDICE_LIB)/lib$(LIB_NAME).a

TDICE_TEST_EXE       = $(TDICE_TEST)/FillThermalData

#
# SuperLU variables
###############################################################################

SLU_MAIN    = $(TDICE_MAIN)/../EPFL/SuperLU_4.0
SLU_INCLUDE = $(SLU_MAIN)/SRC
SLU_LIB     = $(SLU_MAIN)/lib
SLU_LIBS    = $(SLU_LIB)/libsuperlu_4.0.a $(SLU_LIB)/blas_linux.a

#
# HotSpot tool variables
###############################################################################

HST_NAME      = hotspot2threedice
HST_DIR       = $(TDICE_MAIN)/$(HST_NAME)

#
# Commands and flags
###############################################################################

AR        = ar
ARFLAGS   = rsv

CC        = gcc
CFLAGS    = -MD -g 
CINCLUDES = -I $(TDICE_INCLUDE)

YACC      = bison
YFLAGS    = -d

LEX       = flex
LFLAGS    =

RM        = rm
RMFLAGS   = -vf

#
# Pattern rules
###############################################################################

%.c: %.y
	$(YACC) $(YFLAGS) $(notdir $<)

%.c: %.l
	$(LEX) $(LFLAGS) $(notdir $<)

%.o : %.c
	$(CC) $(CFLAGS) $(CINCLUDES) -c $< -o $@
	@cp $*.d $*.dd
	@sed -e 's/#.*//'       \
             -e 's/^[^:]*: *//' \
             -e 's/ *\\$$//'    \
	     -e '/^$$/ d'       \
             -e 's/$$/ :/' < $*.dd >> $*.d
	@rm -f $*.dd

